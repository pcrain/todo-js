<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="styles.css">
    <script type="text/javascript" src="jquery-3.2.0.js"></script>
    <script>
      // Global Variables
        var fields = [];
        var allTasks = {};

      // Formatting methods

        function indentTextString(i)    {
          return 'padding: 0 0 0 '+(i*20).toString()+'px;';
        }

        function taskBG(col)    {
          // gradient = "-webkit-linear-gradient(right, "+col+", rgba(255,255,255,255))";
          gradient = "-webkit-linear-gradient(225deg, rgba(255,255,255,1), "+col+")";
          return 'background-image: '+gradient+';';
        }

        function parseYmdDate(datestring,retString=true) {
          splitDate = datestring.split("/");
          date = new Date(parseInt(splitDate[0]),parseInt(splitDate[1])-1,parseInt(splitDate[2]));
          if (retString)
            return date.toDateString();
          return date;
        }

        function parseHmsTime(timestring,retString=true) {
          splitTime = timestring.split("_");
          time = new Date();
          time.setHours(splitTime[0]);
          time.setMinutes(splitTime[1]);
          time.setSeconds(splitTime[2]);
          if (retString)
            return time.toTimeString();
          return time;
        }

      // Task Getters

        function getTaskColor(task) {
          if (parseInt(task["completion"]) == 1) {
            task['_color'] = "gray"
            return task['_color'];
          }

          if (! task['_available']) {
            task['_color'] = "gray"
            return task['_color'];
          }

          if (task['color'] != "") {
            task['_color'] = task['color']
            return task['color'];
          }

          if (task['parent'] > 0) { //Inherit
            task['_color'] = allTasks[task["parent"]]["_color"];
            return task['_color'];
          }

          task['_color'] = "gray";
          return task['_color'];
        }

        function getTaskDueDate(task) {
          return task['_dueDateTime'];
          // d = task['dueDate'];
          // return (d != "" ? parseYmdDate(d) : d);
        }

        function getTaskDueTime(task) {
          t = task['dueTime'];
          return (t != "" ? parseHmsTime(t) : t);
        }

        function getTaskSchedDate(task) {
          return task['_schedDateTime'];
          // d = task['schedDate'];
          // return (d != "" ? parseYmdDate(d) : d);
        }

        function getTaskSchedTime(task) {
          t = task['schedTime'];
          return (t != "" ? parseHmsTime(t) : t);
        }

        function getTaskStartDate(task) {
          return task['_startDateTime'];
          // d = task['startDate'];
          // return (d != "" ? parseYmdDate(d) : d);
        }

        function getTaskStartTime(task) {
          t = task['startTime'];
          return (t != "" ? parseHmsTime(t) : t);
        }

        function getTaskProject(task) {
          //Get explicitly stated project
          if (task['project'] != "") {
            task['_project'] = task['project'];
            return task['_project'];
          }
          //Use previously computed project
          if ('_project' in task) {
            return task['_project'];
          }
          //Infer project from parent
          if (task['parent'] > 0) { //Inherit
            task['_project'] = allTasks[task["parent"]]["_project"];
            return task['_project'];
          }
          //Return a default
          return "default";
        }

        function getTaskProgress(task) {
          comp = task['completion'];
          return '<meter value="'+comp+'"></meter>';
        }

      // Task Modification

        function writeTaskTooltip(task) {
          var ss = "";
          ss += '<div class="tooltipclass">';
          ss += "<table class='tttable'>"
          ss += "<tr><td>Task</td><td>["+task["id"]+"] "+task["desc"]+"</td></tr>";
          ss += "<tr><td>Project</td><td>"+getTaskProject(task)+"</td></tr>";
          ss += "<tr><td colspan='2'><hr/></td></tr>";
          ss += "<tr><td colspan='2'>"+task["_dependencies"]+"</td></tr>";
          ss += "<tr><td colspan='2'>"+task["_tooltip"]+"</td></tr>";
          ss += "</table>";
          ss += '</div>';
          return ss;
        }

        function newSubTask(id) {
          if (! confirm("Add subtask for '"+allTasks[id]['desc']+"'?")) {
            return;
          }

          var parentTask = allTasks[id];
          var maxId = 0;
          for(key in allTasks) {
            var pi = parseInt(allTasks[key]["id"]);
            if (pi > maxId) {
              maxId = pi;
            }
          }
          maxId += 1;

          //Clone the parent task and reset some attributes
          var newTask = jQuery.extend(true, {}, allTasks[id]);
          allTasks[""+maxId.toString()] = newTask;
          newTask["id"] = maxId.toString();
          newTask["desc"] = "Task "+newTask["id"];
          newTask["parent"] = id;
          newTask["children"] = [];
          newTask["_depth"] = allTasks[id]["_depth"]+1;
          allTasks[id]["children"].push(newTask);

          //Open modify task dialogue
          modifyTask(maxId);

          //Redraw the tasks while we're waiting
          rewriteAllTasks();
        }

        //TODO: finish this
        function deleteTask(id,confirmDelete=true) {
          $('tr.taskRow').each(function(){
            var tr = $(this);
            var rowid = tr.find('td:eq(0)').text();
            if (id == rowid) {
              if (!confirmDelete || confirm("Delete task '"+allTasks[id]['desc']+"' add all children?")) {
                for (var j = allTasks[id]["children"].length -1; j >= 0; --j ) {
                  deleteTask(allTasks[id]["children"][j]["id"],false);
                }
                tr.remove();
                if(parent in allTasks[id]) {
                  parent = allTasks[allTasks[id]["parent"]];
                  for (var j = 0; j < parent["children"].length; ++j) {
                    if (parent["children"][j]["id"] == id) {
                      parent["children"].splice(j,1);
                      break;
                    }
                  }
                }
                delete allTasks[id];
              }
              return;
            }
          });
        }

        function modifyTask(id) {
          dismissModifedTask();
          var task = allTasks[id];
          var div = document.createElement('div');
          div.id = "editTaskForm";

          var ss = "";
          ss += "<table>";
            ss += addModifiableField("Task Name","modify_desc",task["desc"]);
            ss += addModifiableField("Due Date","modify_dueDate",task["dueDate"]);
            ss += addModifiableField("Due Time","modify_dueTime",task["dueTime"]);
            ss += addModifiableField("Sched. Date","modify_schedDate",task["schedDate"]);
            ss += addModifiableField("Sched. Time","modify_schedTime",task["schedTime"]);
            ss += addModifiableField("Start Date","modify_startDate",task["startDate"]);
            ss += addModifiableField("Start Time","modify_startTime",task["startTime"]);
            ss += addModifiableField("Project","modify_project",task["project"]);
            ss += addModifiableField("Color","modify_color",task["color"]);
            ss += addModifiableField("Est. Time","modify_estTime",task["estTime"]);
            ss += addModifiableField("Parent","modify_parent",task["parent"]);
            ss += addModifiableField("Dependencies","modify_deps",task["deps"]);
            ss += addModifiableField("Completion","modify_completion",task["completion"]);
          ss += "<td><input onclick='dismissModifedTask()' type='button' value='dismiss'/></td>";
          ss += "<td><input onclick='submitModifiedTask("+id+")' type='button' value='modify'/></td>";
          ss += "</tr>";
          ss += "</table>";

          div.innerHTML = ss;
          $('body').append(div);
          setTimeout(function(){div.className += "onAdd";},10);
        }

        function refreshTaskId(id) {
          var task = allTasks[id];
          computeExtraTaskData(task);
          $('tr.taskRow').each(function(){
              var tr = $(this);
              var rowid = tr.find('td:eq(0)').text();
              if (id == rowid) {
                tr.find('td:eq(0)').parent().replaceWith(
                  writeTaskData(task,task["_depth"],false)
                );
                return;
              }
          });
        }

        function submitModifiedTask(id) {
          var task = allTasks[id];

          //Update task with new modified information
          task["desc"] = document.getElementById("modify_desc").value;
          task["dueDate"] = document.getElementById("modify_dueDate").value;
          task["dueTime"] = document.getElementById("modify_dueTime").value;
          task["schedDate"] = document.getElementById("modify_schedDate").value;
          task["schedTime"] = document.getElementById("modify_schedTime").value;
          task["startDate"] = document.getElementById("modify_startDate").value;
          task["startTime"] = document.getElementById("modify_startTime").value;
          task["project"] = document.getElementById("modify_project").value;
          task["color"] = document.getElementById("modify_color").value;
          task["estTime"] = document.getElementById("modify_estTime").value;
          task["parent"] = document.getElementById("modify_parent").value;
          task["deps"] = document.getElementById("modify_deps").value;
          task["completion"] = document.getElementById("modify_completion").value;
          computeExtraTaskData(task);

          //Find and replace the relevant table row
          refreshTaskId(task["id"]);

          dismissModifedTask();
        }

        function dismissModifedTask() {
          var olddiv = document.getElementById("editTaskForm");
          if (olddiv != null) {
            olddiv.parentNode.removeChild(olddiv);
          }
        }

        function addModifiableField(title,id,defVal,callback=null) {
          var cb = "";
          if (callback != null) {
            cb = 'onchange="'+callback+'(this.value)"';
          }
          var ss = ""
            +"<tr><td>"+title+"</td><td>"
            +'<input type="text" value="'
            +defVal
            +'" id="'+id+'" '+cb+'"/>'
            +"</td></tr>";
          return ss;
        }

      // Task Table Writers / Modifiers

        function writeAllTaskData() {
          var ss = "";
          ss += ('<table id="taskTable" class="tablesorter">');
          ss += writeTaskHeaders();
          ss += ('<tbody>');
          ss += writeTaskTable();
          ss += ('</tbody>');
          ss += ('</table>');
          return ss;
        }

        function writeTaskHeaders() {
          var ss = "";
          ss += ('<thead><tr>');
          // ss += ('<th class="exportButton" onclick="downloadData()">')
          ss += ('<th>')

            //Download
            ss += ('<img ');
            ss += ('onclick="downloadData()" ');
            // ss += ('onclick="downloadData('+task['id']+')" ');
            ss += ('class="actionicon" src="./images/download.png"></img> ');

            //Refresh
            ss += ('<img ');
            ss += ('onclick="rewriteAllTasks()" ');
            ss += ('class="actionicon" src="./images/refresh.png"></img> ');

            //Global Collapse
            ss += ('<img ');
            ss += ('onclick="collapseAllTasks()" ');
            ss += ('class="actionicon" src="./images/minus-all.png"></img> ');

            //Global Expand
            ss += ('<img ');
            ss += ('onclick="expandAllTasks()" ');
            ss += ('class="actionicon" src="./images/plus-all.png"></img> ');

          ss += ('</th>');
          ss += ('<th class="sortableHeader" onclick="sortTasks('+"'id',true"+')">Task</th>');
          ss += ('<th class="sortableHeader" onclick="sortTasks('+"'completion'"+')">Progress</th>');
          ss += ('<th class="sortableHeader" onclick="sortTasks('+"'_dueDateTime'"+')">Due Date</th>');
          ss += ('<th class="sortableHeader" onclick="sortTasks('+"'_schedDateTime'"+')">Sched. Date</th>');
          ss += ('<th class="sortableHeader" onclick="sortTasks('+"'_startDateTime'"+')">Start Date</th>');
          ss += ('<th class="sortableHeader" onclick="sortTasks('+"'estTime'"+')">Est. Time</th>');
          ss += ('</tr></thead>');
          return ss;
        }

        function writeTaskTable() {
          var ss = "";
          var unavailable = [];
          for (var key in allTasks) {
            if (allTasks[key]["parent"] == 0) {
              if (allTasks[key]["_available"]) {
                ss += writeTaskData(allTasks[key],0);
              } else {
                unavailable.push(allTasks[key]);
              }
            }
          }
          for (var i = 0; i < unavailable.length; ++i) {
            ss += writeTaskData(unavailable[i],0);
          }
          return ss;
        }

        function writeTaskData(task,indent=0,recursive=true) {
          task["_depth"] = indent;
          var ss = "";
          ss += ('<tr class="taskRow onAdd">');
            ss += ('<td class="invisible">'+task['id']+'</td>');
            ss += writeTaskActions(task);
            ss += writeTaskDescription(indent,task);
            ss += ('<td>'+getTaskProgress(task)+'</td>');
            ss += ('<td>'+getTaskDueDate(task)+'</td>');
            ss += ('<td>'+getTaskSchedDate(task)+'</td>');
            ss += ('<td>'+getTaskStartDate(task)+'</td>');
            ss += writeTaskEstimatedTime(task);
          ss += ('</tr>');
          if (recursive) {
            var unavailable = [];
            for (var j = 0; j < task["children"].length; j++) {
              if (task["children"][j]["_available"]) {
                ss += writeTaskData(task["children"][j],indent+1);
              } else {
                unavailable.push(task["children"][j]);
              }
            }
            for (var i = 0; i < unavailable.length; ++i) {
              ss += writeTaskData(unavailable[i],indent+1);
            }
          }
          return ss;
        }

        function writeTaskActions(task) {
          var ss = "";
          //Check
          ss += ('<td class="actiontd">');
          ss += ('<img onclick="toggleCompletion('+task['id']+')" ');
          if (parseInt(task["completion"]) == 1) {
            ss += ('class="actionicon" src="./images/check.png"></img> ');
          } else {
            ss += ('class="actionicon" src="./images/check-off.png"></img> ');
          }

          //Remove task
          ss += ('<img ');
          ss += ('onclick="deleteTask('+task['id']+')" ');
          ss += ('class="actionicon" src="./images/deletetask.png"></img> ');

          //New subtask
          ss += ('<img ');
          ss += ('onclick="newSubTask('+task['id']+')" ');
          ss += ('class="actionicon" src="./images/newtask.png"></img> ');

          if (task['children'].length > 0) {
            if (! task["_collapsed"]) {
              //Collapse
              ss += ('<img ');
              ss += ('onclick="collapseTask('+task['id']+')" ');
              ss += ('class="actionicon" src="./images/minus.png"></img> ');
            } else {
              //Expand
              ss += ('<img ');
              ss += ('onclick="expandTask('+task['id']+')" ');
              ss += ('class="actionicon" src="./images/plus.png"></img> ');
            }
          } else {
              ss += ('<img ');
              ss += ('onclick="collapseTask('+task['id']+')" ');
              ss += ('class="zeroopacity actionicon" src="./images/minus.png"></img> ');
          }

          ss += "</td>";
          return ss;
        }

        function writeTaskDescription(indent,task) {
          var ss = "";
          var color = getTaskColor(task);
          ss += ('<td><div class="indentDiv" style="'
            +indentTextString(indent)
            +'" onclick="modifyTask('+task["id"]+')">'
            +'<div class="highlight" style="'
            +taskBG(color)
            +'">'
          );
          ss += (task['desc']);
          ss += (writeTaskTooltip(task));
          ss += ('</div></div></div></td>');
          return ss;
        }

        function writeTaskEstimatedTime(task) {
          var ss = "";
          ss += ('<td>');
          etime = task['estTime'];
          if (etime != "") {
            var time = etime.substr(0,etime.length - 1);
            var unit = etime.substr(etime.length - 1);
            if (unit == 'h') {
              time = time*60;
            }
            ss += (parseInt(time)+"m");
          }
          ss += ('</td>');
          return ss;
        }

        function rewriteAllTasks() {
          var trows = "";
          trows += writeTaskHeaders();
          for (key in allTasks) {
            if (allTasks[key]["parent"] != "") {
              continue;
            }
            trows += writeTaskData(allTasks[key],0,true);
          }
          $("#taskTable tbody tr").remove();
          document.getElementById("taskTable").innerHTML = trows;
        }

        function sortTasks(sortKey,recurse=false) {
          var trows = "";
          trows += writeTaskHeaders();

          ntasks = Object.keys(allTasks).length;
          var writtenIDs = {};
          for (var i = 0; i < ntasks; ++i) {
            var minval = "";
            var minid = -1;
            for (var key in allTasks) {
              //Skip children if we're recursing
              if (recurse && allTasks[key]['parent'] != "") {
                continue;
              }
              //Skip things we've already written
              if (key in writtenIDs) {
                continue;
              }
              //Automatically addthe first nonwritten value
              if (minid == -1) {
                minval = allTasks[key][sortKey];
                minid = key;
                continue;
              }
              //Automatically replace with the first non-null value
              if (taskVal != "" && taskVal != " ") {
                if (minval == "" || minval == " ") {
                  minval = allTasks[key][sortKey];
                  minid = key;
                  continue;
                }
              }
              //Compare with the new value
              var taskVal = allTasks[key][sortKey];
              if (taskVal.localeCompare(minval) == -1) {
                if (taskVal == "" || taskVal == " ")
                  continue;
                minval = taskVal;
                minid = key;
              }
            }
            if (minid == -1) {
              break;
            }
            writtenIDs[minid] = true;
            trows += writeTaskData(allTasks[minid],0,recurse);
          }
          $("#taskTable tbody tr").remove();
          document.getElementById("taskTable").innerHTML = trows;
        }

        function toggleCompletion(id) {
          if(parseInt(allTasks[id]["completion"]) == 1) {
            updateTask(id,"completion",0);
          } else {
            updateTask(id,"completion",1);
          }
        }

        function updateTask(id,key,value) {
          allTasks[id][key] = value;
          refreshTaskId(id);
        }

        function expandAllTasks() {
          for (var key in allTasks) {
            if (allTasks[key]["parent"] == "") {
              allTasks[key]["_collapsed"] = false;
              refreshTaskId(key);
              expandTask(key,true,true);
            }
          }
        }

        function expandTask(id,first=true,recurse=false) {
          // alert("expand "+id);
          if (first || recurse) {
            allTasks[id]["_collapsed"] = false;
          } else {
            // allTasks[id]["_collapsed"] = false;
          }
          refreshTaskId(id);
          $('tr.taskRow').each(function(){
              var tr = $(this);
              var rowid = tr.find('td:eq(0)').text();
              if (id == rowid) {
                //Force transition
                if (! first) {
                  tr.hide();
                  tr.addClass("onCollapse");
                  tr.removeClass("onAdd");
                }
                tr.show();
                tr.removeClass("onCollapse");
                tr.addClass("onAdd");
              }
          });
          if (! allTasks[id]["_collapsed"]) {
            for (var i = 0; i < allTasks[id]["children"].length; ++i) {
              expandTask(allTasks[id]["children"][i]['id'],false,recurse);
            }
          }
        }

        function collapseAllTasks() {
          for (var key in allTasks) {
            if (allTasks[key]["parent"] == "") {
              allTasks[key]["_collapsed"] = true;
              refreshTaskId(key);
              collapseTask(key,true,true);
            }
          }
        }

        function collapseTask(id,first=true,recurse=false) {
          // alert("collapse "+id);
          if (recurse || first) {
            allTasks[id]["_collapsed"] = true;
          }
          for (var i = 0; i < allTasks[id]["children"].length; ++i) {
            collapseTask(allTasks[id]["children"][i]['id'],false,recurse);
          }
          if(!first) {
            $('tr.taskRow').each(function(){
                var tr = $(this);
                var rowid = tr.find('td:eq(0)').text();
                if (id == rowid) {
                  tr.removeClass("onAdd");
                  tr.addClass("onCollapse");
                  setTimeout(function(){tr.hide();},500);
                }
            });
          }
          else {
            refreshTaskId(id);
          }
        }

      // CSV saving / loading

        //Read in a todo-data CSV from the specified file and store it in allTasks
        function parseTaskCSV(file) {
          var rawFile = new XMLHttpRequest();
          rawFile.open("GET", file, false);
          rawFile.onreadystatechange = function () {
            if(rawFile.readyState === 4) {
              if(rawFile.status === 200 || rawFile.status == 0) {
                var allText = rawFile.responseText.split('\n');
                var toWrite = "";
                for(var line = 0; line < allText.length; line++) {
                  if (allText[line].length < 1) {
                    continue;
                  }
                  split = allText[line].split('|');
                  if (split[0] == "") { //Ignore if no id
                    continue;
                  }
                  //Get field names from first line
                  if (line == 0) {
                    for (i = 0; i < split.length; i++) {
                      fields.push(split[i]);
                    }
                    continue;
                  }
                  var taskData = {};
                  taskData["_depth"] = 0;
                  taskData["children"] = [];
                  for (var i = 0; i < split.length; i++) {
                    taskData[fields[i]] = split[i];
                  }
                  allTasks[taskData["id"]] = taskData;
                }
                //Write Children
                for (key in allTasks) {
                  if (allTasks[key]["parent"] > 0) {
                    allTasks[allTasks[key]["parent"]]["children"].push(allTasks[key]);
                  }
                }
              }
            }
          }
          rawFile.send(null);
        }


        function generateCSV() {
          var ss = "id|parent|deps|completion|desc|project|dueDate|dueTime|schedDate|schedTime|startDate|startTime|color|estTime|priority\n";
          for (var key in allTasks) {
            var task = allTasks[key];
            if (task["parent"] == "") {
              ss += generateCSVRow(task);
            }
          }
          ss = ss.replace(/[\u2018\u2019]/g, "'");
          return ss;
        }

        function generateCSVRow(task) {
          var ss = "";
          ss += task['id']+"|";
          ss += task['parent']+"|";
          ss += task['deps']+"|";
          ss += task['completion']+"|";
          ss += task['desc']+"|";
          ss += task['project']+"|";
          ss += task['dueDate']+"|";
          ss += task['dueTime']+"|";
          ss += task['schedDate']+"|";
          ss += task['schedTime']+"|";
          ss += task['startDate']+"|";
          ss += task['startTime']+"|";
          ss += task['color']+"|";
          ss += task['estTime']+"|";
          ss += task['priority'];
          ss += "\n";

          for (var j = 0; j < task["children"].length; j++) {
            child = allTasks[task["children"][j]["id"]];
            ss += generateCSVRow(child);
          }

          return ss;
        }

        function downloadData() {
          download(generateCSV(),"_newdata.csv","text/plain");
        }

        //From http://stackoverflow.com/questions/21012580/is-it-possible-to-write-data-to-file-using-only-javascript
        function download(strData, strFileName, strMimeType) {
            var D = document,
                A = arguments,
                a = D.createElement("a"),
                d = A[0],
                n = A[1],
                t = A[2] || "text/plain";

            //build download link:
            a.href = "data:" + strMimeType + "charset=utf-8," + escape(strData);


            if (window.MSBlobBuilder) { // IE10
                var bb = new MSBlobBuilder();
                bb.append(strData);
                return navigator.msSaveBlob(bb, strFileName);
            } /* end if(window.MSBlobBuilder) */



            if ('download' in a) { //FF20, CH19
                a.setAttribute("download", n);
                // a.innerHTML = "downloading...";
                D.body.appendChild(a);
                setTimeout(function() {
                    var e = D.createEvent("MouseEvents");
                    e.initMouseEvent("click", true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
                    a.dispatchEvent(e);
                    D.body.removeChild(a);
                }, 66);
                return true;
            }; /* end if('download' in a) */



            //do iframe dataURL download: (older W3)
            var f = D.createElement("iframe");
            D.body.appendChild(f);
            f.src = "data:" + (A[2] ? A[2] : "application/octet-stream") + (window.btoa ? ";base64" : "") + "," + (window.btoa ? window.btoa : escape)(strData);
            setTimeout(function() {
                D.body.removeChild(f);
            }, 333);
            return true;
        }

      // Todo list data generation

        //TODO: heavily clean up this function
        function computeExtraTaskData(task) {
          if (task['completion'] == "") {
            task['completion'] = "0";
          }

          if (! "_collapsed" in task) {
            task["_collapsed"] = false;
          }
          task["_tooltip"] = "This task can be done now.";
          task["_dependencies"] = "";
          task["_dueDateTime"] = task["dueDate"]+" "+task["dueTime"];
          task["_schedDateTime"] = task["schedDate"]+" "+task["schedTime"];
          task["_startDateTime"] = task["startDate"]+" "+task["startTime"];

          task['_available'] = true;

          var startDate = parseYmdDate(task['startDate'],false);
          if (parseInt(task["completion"]) == 1) {
            task['_available'] = false;  //Don't need to do finished tasks
            task["_tooltip"] = "Already done!";
          } else if (startDate > Date.now()) { //TODO: not guaranteed to have a valid startDate
            task['_available'] = false;  //Can't do future tasks
            task["_tooltip"] = "Not available until "+task['startDate']+" at "+task['startTime'];
          }
          if (task["deps"] != "") {
            var deps = task['deps'].split(",");
            if (deps.length > 0) {
              task["_dependencies"] = "Cannot do until the following tasks are done:\n\n";
            }
            for (var i = 0; i < deps.length; ++i) {
              if (! ("_dependents" in allTasks[deps[i]])) {
                allTasks[deps[i]]["_dependents"] = [];
              }
              allTasks[deps[i]]["_dependents"].push(task["id"]);
              var depCompleted = parseInt(allTasks[deps[i]]["completion"]) == 1;
              if (!depCompleted) {
                if (task['_available']) {
                  task['_available'] = false;  //Can't do a task with dependencies
                  task["_tooltip"] = "Has dependencies";
                }
              }
              if (depCompleted) {
                status = "./images/check.png";
              } else {
                status = "./images/cross.png";
              }
              task["_dependencies"] += "<img class='tooltipicon' src='"+status+"'></img>  "
              +allTasks[deps[i]]["desc"]+"\n";
            }
            task["_dependencies"] +=  "<tr><td colspan='2'><hr/></td></tr>";
          }
        }

        function computeAllExtraTaskData() {
          for (var key in allTasks) {
            computeExtraTaskData(allTasks[key]);
          }
        }

        function generateHTML () {
          // parseTaskCSV("file:///home/pretzel/workspace/todo-js/_newdata.csv");
          parseTaskCSV("file:///home/pretzel/workspace/todo-js/data.csv");
          computeAllExtraTaskData();
          document.write(writeAllTaskData());
        }
    </script>
  </head>
  <body><script>
    generateHTML();
    $(document).keyup(function(e) {
      if (e.keyCode == 27) { // escape key maps to keycode `27`
        dismissModifedTask();
      }
    });
  </script></body>
</html>
