<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/jquery-ui.css">
    <link rel="stylesheet" href="css/jquery-ui.timepicker.css">
    <link rel="stylesheet" href="css/chosen.min.css">
    <script type="text/javascript" src="js/jquery-3.2.0.js"></script>
    <script type="text/javascript" src="js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="js/jquery.ui.timepicker.js"></script>
    <script type="text/javascript" src="js/chosen.jquery.min.js"></script>
    <script>
      // Global Variables
        var _config = {};
        var configLoaded = false;
        var defaultSort = "desc";
        var defaultSortChild = true;
        var fields = [];
        var allTasks = {};
        var madeChanges = false;
        var weekday = new Array(7);
          weekday[0] = "Sunday     ";
          weekday[1] = "Monday     ";
          weekday[2] = "Tuesday    ";
          weekday[3] = "Wednesday  ";
          weekday[4] = "Thursday   ";
          weekday[5] = "Friday     ";
          weekday[6] = "Saturday   ";

      // Formatting methods

        function setChangesMade() {
          if (! madeChanges) {
            madeChanges = true;
            $(window).bind('beforeunload', function(){ return 'Leave without saving?'; });
          }
        }

        function unsetChangesMade() {
          if (madeChanges) {
            madeChanges = false;
            $(window).unbind('beforeunload');
            // window.onbeforeunload = null;
          }
        }

        function indentTextString(i)    {
          return 'padding: 0 0 0 '+(i*20).toString()+'pt;';
        }

        function taskBG(col)    {
          // gradient = "-webkit-linear-gradient(right, "+col+", rgba(255,255,255,255))";
          gradient = "-webkit-linear-gradient(225deg, rgba(255,255,255,1), "+col+")";
          return 'background-image: '+gradient+';';
        }

        function parseYmdDate(datestring,retString=true) {
          splitDate = datestring.split("/");
          date = new Date(parseInt(splitDate[0]),parseInt(splitDate[1])-1,parseInt(splitDate[2]));
          if (retString)
            return date.toDateString();
          return date;
        }

        function unparseYmdDate(date) {
          d = date.getDate();
          d = (d < 10) ? "0"+d.toString() : d.toString();
          m = date.getMonth()+1;
          m = (m < 10) ? "0"+m.toString() : m.toString();
          return date.getFullYear()+"/"+m+"/"+d;
        }


        function parseHmsTime(timestring,retString=true) {
          splitTime = timestring.split("_");
          time = new Date();
          time.setHours(splitTime[0]);
          time.setMinutes(splitTime[1]);
          time.setSeconds(splitTime[2]);
          if (retString)
            return time.toTimeString();
          return time;
        }

      // Task Getters

        function initTaskColors(task=null) {
          if (task != null) {
            for(var i = 0; i < task["children"].length; ++i) {
              initTaskColors(task["children"][i]);
            }
            return;
          }
          for (var key in allTasks) {
            if (allTasks[key]["parent"] == "") {
              getTaskColor(allTasks[key]);
              for(var i = 0; i < allTasks[key]["children"].length; ++i) {
                initTaskColors(allTasks[key]["children"][i]);
              }
            }
          }
        }

        function getTaskColor(task) {
          if (parseInt(task["completion"]) == 1) {
            task['_color'] = "black";
            return task['_color'];
          }

          if (! task['_available']) {
            task['_color'] = "gray";
            return task['_color'];
          }

          if (task['color'] != "") {
            task['_color'] = task['color'];
            return task['color'];
          }

          if (task['parent'] > 0) { //Inherit
            task['_color'] = allTasks[task["parent"]]["_color"];
            return task['_color'];
          }

          task['_color'] = "gray";
          return task['_color'];
        }

        function getTaskDueDate(task,shortDate=false) {
          var className = "laterDueDate";
          var ss = "";
          var dd = task['dueDate'];
          var pd = task['_dueDateTime'];
          if (dd != "" && task["completion"] < 1) {
            beginToday = new Date(); beginToday.setHours(0); beginToday.setMinutes(0);
            dd = parseYmdDate(dd,false);
            var dow = dd.getDay();
            dd = Math.round((dd-beginToday)/86400000);
            if (dd < 0) {
              if (shortDate && dd == -1) {
                pd = "Yesterday  "+task['dueTime'];
              }
              className = 'overDueDate';
            } else if (dd <= 1) { //Scheduled within 48 hours
              className = 'verysoonDueDate';
              if(shortDate) {
                pd = ((dd == 1) ? "Tomorrow" : "Today   ")+"   "+task['dueTime'];
              }
            } else if (dd <= 7) { //Scheduled within a week
              className = 'soonDueDate';
              if(shortDate) {
                pd = weekday[dow]+task['schedTime'];
              }
            }
          }
          ss += "<td class='"+className+"'>";
          ss += pd;
          ss += "</td>";
          return ss;
        }

        function getTaskDueTime(task) {
          t = task['dueTime'];
          return (t != "" ? parseHmsTime(t) : t);
        }

        function getTaskSchedDate(task,shortDate=false) {
          var className = "laterSchedDate";
          var ss = "";
          var dd = task['schedDate'];
          var pd = task['_schedDateTime'];
          if (dd != "" && task["completion"] < 1) {
            beginToday = new Date(); beginToday.setHours(0); beginToday.setMinutes(0);
            dd = parseYmdDate(dd,false);
            var dow = dd.getDay();
            dd = Math.round((dd-beginToday)/86400000);
            if (dd < 0) {
              if (shortDate && dd == -1) {
                pd = "Yesterday  "+task['dueTime'];
              }
              className = 'overDueDate';
            } else if (dd <= 1) { //Scheduled within 48 hours
              className = 'verysoonSchedDate';
              if(shortDate) {
                pd = ((dd == 1) ? "Tomorrow" : "Today   ")+"   "+task['schedTime'];
              }
            } else if (dd <= 7) { //Scheduled within a week
              className = 'soonSchedDate';
              if(shortDate) {
                pd = weekday[dow]+task['schedTime'];
              }
            }
          }
          ss += "<td class='"+className+"'>";
          ss += pd;
          ss += "</td>";
          return ss;
        }

        function getTaskSchedTime(task) {
          t = task['schedTime'];
          return (t != "" ? parseHmsTime(t) : t);
        }

        function getTaskStartDate(task,shortDate=false) {
          return "<td>"+task['_startDateTime']+"</td>";
          // d = task['startDate'];
          // return (d != "" ? parseYmdDate(d) : d);
        }

        function getTaskStartTime(task) {
          t = task['startTime'];
          return (t != "" ? parseHmsTime(t) : t);
        }

        function getTaskProject(task) {
          //Get explicitly stated project
          if (task['project'] != "") {
            task['_project'] = task['project'];
            return task['_project'];
          }
          //Use previously computed project
          if ('_project' in task) {
            return task['_project'];
          }
          //Infer project from parent
          if (task['parent'] > 0) { //Inherit
            task['_project'] = allTasks[task["parent"]]["_project"];
            return task['_project'];
          }
          //Return a default
          return "default";
        }

        function getTaskProgress(task) {
          comp = task['completion'];
          return '<meter value="'+comp+'"></meter>';
        }

      // Task Modification

        function writeTaskTooltip(task) {
          var ss = "";
          ss += '<div class="tooltipclass">';
          ss += "<table class='tttable'>"
          ss += "<tr><td>Task</td><td>["+task["id"]+"] "+task["desc"]+"</td></tr>";
          ss += "<tr><td>Project</td><td>"+getTaskProject(task)+"</td></tr>";
          ss += "<tr><td colspan='2'><hr/></td></tr>";
          ss += "<tr><td colspan='2'>"+task["_dependencies"]+"</td></tr>";
          ss += "<tr><td colspan='2'>"+task["_tooltip"]+"</td></tr>";
          ss += "</table>";
          ss += '</div>';
          return ss;
        }

        function newSubTask(id) {
          if (! confirm("Add subtask for '"+allTasks[id]['desc']+"'?")) {
            return;
          }

          var maxId = 0;
          for(key in allTasks) {
            var pi = parseInt(allTasks[key]["id"]);
            if (pi > maxId) {
              maxId = pi;
            }
          }
          maxId += 1;

          //Clone the parent task and reset some attributes
          var parentTask = allTasks[id];
          setChangesMade();
          var newTask = jQuery.extend(true, {}, parentTask);
          allTasks[""+maxId.toString()] = newTask;
          for(var key in newTask) {
            newTask[key] = "";
          }
          newTask["id"] = maxId.toString();
          newTask["desc"] = "Task "+newTask["id"];
          newTask["parent"] = id;
          newTask["children"] = [];
          newTask["dueDate"] = parentTask["dueDate"];
          newTask["dueTime"] = parentTask["dueTime"];
          newTask["startDate"] = parentTask["startDate"];
          newTask["startTime"] = parentTask["startTime"];
          newTask["_depth"] = parentTask["_depth"]+1;
          parentTask["children"].push(newTask);

          //Open modify task dialogue
          modifyTask(maxId);

          //Redraw the tasks while we're waiting
          rewriteAllTasks();
        }

        //TODO: finish this
        function deleteTask(id,confirmDelete=true) {
          $('tr.taskRow').each(function(){
            var tr = $(this);
            var rowid = tr.find('td:eq(0)').text();
            if (id == rowid) {
              if (!confirmDelete || confirm("Delete task '"+allTasks[id]['desc']+"' add all children?")) {
                for (var j = allTasks[id]["children"].length -1; j >= 0; --j ) {
                  deleteTask(allTasks[id]["children"][j]["id"],false);
                }
                tr.remove();
                if("parent" in allTasks[id] && allTasks[id]["parent"] != "") {
                  parent = allTasks[allTasks[id]["parent"]];
                  for (var j = 0; j < parent["children"].length; ++j) {
                    if (parent["children"][j]["id"] == id) {
                      parent["children"].splice(j,1);
                      break;
                    }
                  }
                }
                setChangesMade();
                delete allTasks[id];
                // alert("delete "+id);
              }
              return;
            }
          });
        }

        function addDatePicker(elementId,selectedId="") {
          var id = "#"+elementId;
          $( id ).datepicker({
            showOtherMonths: true, selectOtherMonths: true, dateFormat: "yy/mm/dd",
            currentText: "Now", gotoCurrent: true, showAnim: "slideDown"
          });
          if (elementId == selectedId) {
            setTimeout(function(){$( id ).datepicker( "show" );},1000);
          }
          //Disable manual input
          // $( id ).keypress(function(event) { event.preventDefault(); return false; });
        }

        function addTimePicker(elementId) {
          var id = "#"+elementId;
          $( id ).timepicker({
            onSelect: (function(time, inst) {
              $(id).val(time+"_00");
            }), timeSeparator: '_'
          });
          //Disable manual input
          // $( id ).keypress(function(event) { event.preventDefault(); return false; });
        }

        function addTaskPicker(elementId) {
          // return;
          var id = "#"+elementId;
          // echo '<select class=chosen-select name="p1tag">';
          // for ($i = 0; $i < count($allplayers); $i ++) {
          //   echo "<option value='".$allplayers[$i]['player_id']."'>" . $allplayers[$i]['unique_tag'] . "</option>";
          // }
          $(id).chosen({
            enable_split_word_search: false,
            no_results_text: "Task not found!",
            width: "100%",
            search_contains : true,
            max_shown_results : 8,
            placeholder_text_multiple: "No Dependencies"
          });
          $(id).on('change', function(evt, params) {
            // alert($(id).val());
            // for (var p in $(id)) {
            //   alert(p+": "+$(id)[p]);
            // }
            // for (var p in params)
            //   alert(p+": "+params[p]);
            // do_something(evt, params);
          });
        }

        function modifyTask(id,selected="modify_desc") {
          dismissModifedTask();
          var task = allTasks[id];
          var div = document.createElement('div');
          div.id = "editTaskForm";

          var ss = "";
          ss += "<table>";
            ss += addModifiableField("Task Name","modify_desc",task["desc"]);
            ss += addModifiableField("Due Date","modify_dueDate",task["dueDate"]);
            ss += addModifiableField("Due Time","modify_dueTime",task["dueTime"]);
            ss += addModifiableField("Sched. Date","modify_schedDate",task["schedDate"]);
            ss += addModifiableField("Sched. Time","modify_schedTime",task["schedTime"]);
            ss += addModifiableField("Start Date","modify_startDate",task["startDate"]);
            ss += addModifiableField("Start Time","modify_startTime",task["startTime"]);
            ss += addModifiableField("Project","modify_project",task["project"]);
            ss += addModifiableField("Recur Rate","modify_recurRate",task["recurRate"]);
            ss += addModifiableField("Color","modify_color",task["color"]);
            ss += addModifiableField("Est. Time","modify_estTime",task["estTime"]);
            ss += addModifiableField("Parent","modify_parent",task["parent"]);
            ss += addSelectField("Dependencies","modify_deps",task["deps"]);
            ss += addModifiableField("Completion","modify_completion",task["completion"]);
          ss += "<td><input onclick='dismissModifedTask()' type='button' value='dismiss'/></td>";
          ss += "<td><input onclick='submitModifiedTask("+id+")' type='button' value='modify'/></td>";
          ss += "</tr>";
          ss += "</table>";

          div.innerHTML = ss;
          $('body').append(div);
          //Focus on first textbox
            $("input:text").focus(function() { $(this).select(); } );
            document.getElementById(selected).focus();
            // $( selected ).datepicker( "show" );
          //Add date pickers
            addDatePicker("modify_dueDate",selected);
            addDatePicker("modify_schedDate",selected);
            addDatePicker("modify_startDate",selected);
          //Add time pickers
            addTimePicker('modify_dueTime');
            addTimePicker('modify_schedTime');
            addTimePicker('modify_startTime');
          //Add task pickers
            addTaskPicker('modify_deps');
          //Add att timeout for visibility
            setTimeout(function(){div.className += "onAdd";},10);
        }

        function refreshTaskId(id) {
          var task = allTasks[id];
          computeExtraTaskData(task);
          $('tr.taskRow').each(function(){
              var tr = $(this);
              var rowid = tr.find('td:eq(0)').text();
              if (id == rowid) {
                tr.find('td:eq(0)').parent().replaceWith(
                  writeTaskData(task,task["_depth"],false)
                );
                return;
              }
          });
        }

        function submitModifiedTask(id) {
          var task = allTasks[id];

          //Update task with new modified information
          setChangesMade();
          task["desc"] = document.getElementById("modify_desc").value;
          task["dueDate"] = document.getElementById("modify_dueDate").value;
          task["dueTime"] = document.getElementById("modify_dueTime").value;
          task["schedDate"] = document.getElementById("modify_schedDate").value;
          task["schedTime"] = document.getElementById("modify_schedTime").value;
          task["startDate"] = document.getElementById("modify_startDate").value;
          task["startTime"] = document.getElementById("modify_startTime").value;
          task["project"] = document.getElementById("modify_project").value;
          task["recurRate"] = document.getElementById("modify_recurRate").value;
          task["color"] = document.getElementById("modify_color").value;
          task["estTime"] = document.getElementById("modify_estTime").value;
          task["parent"] = document.getElementById("modify_parent").value;

          //Convert dependencies to comma separated format
          task["deps"] = "";
          rawdeps = $("#modify_deps").val();
          for (d in rawdeps) {
            task["deps"] += ((task["deps"]=="") ? "" : ",")+rawdeps[d];
          }

          task["completion"] = document.getElementById("modify_completion").value;
          computeExtraTaskData(task);

          //Find and replace the relevant table row
          refreshTaskId(task["id"]);

          dismissModifedTask();
        }

        function dismissModifedTask() {
          var olddiv = document.getElementById("editTaskForm");
          if (olddiv != null) {
            olddiv.parentNode.removeChild(olddiv);
          }
        }

        function addSelectField(title,id,defVal) {
          var deps = defVal.split(",");
          var ss = ""
            +"<tr><td>"+title+"</td><td>"
            +'<select multiple class="chosen-select" '
            +' id="'+id+'">';

          for(var key in allTasks) {
            if(deps.indexOf(key) == -1)
              ss += "<option value='"+key+"'>" + allTasks[key]['desc'] + "</option>";
            else
              ss += "<option selected value='"+key+"'>" + allTasks[key]['desc'] + "</option>";
          }

          ss = ss
            +'</select>'
            +"</td></tr>";
          return ss;
        }

        function addModifiableField(title,id,defVal,callback=null) {
          var cb = "";
          if (callback != null) {
            cb = 'onchange="'+callback+'(this.value)"';
          }
          var ss = ""
            +"<tr><td>"+title+"</td><td>"
            +'<input type="text" value="'
            +defVal
            +'" id="'+id+'" '+cb+'"></input>'
            +"</td></tr>";
          return ss;
        }

      // Task Table Writers / Modifiers

        function writeAllTaskData() {
          var ss = "";
          ss += ('<table id="taskTable" class="tablesorter">');
          // ss += writeTaskHeaders();
          ss += ('<tbody>');
          // ss += writeTaskTable();
          ss += ('</tbody>');
          ss += ('</table>');
          return ss;
        }

        function writeSortableHeader(text,sortKey) {
          var ss = "";
          ss += '<th class="sortableHeader">';
          ss += text;

          ss += (' <img class="actionicon" onclick="sortTasks('+"'"+sortKey+"',false,true"+')" ')+('class="actionicon" src="./images/sort-descend.png"></img> ');
          ss += "<div class='tooltipclass'>Sort descending.</div>";
          ss += (' <img class="actionicon" onclick="sortTasks('+"'"+sortKey+"',false,false"+')" ')+('class="actionicon" src="./images/sort-ascend.png"></img> ');
          ss += "<div class='tooltipclass'>Sort ascending.</div>";
          ss += (' <img class="actionicon" onclick="sortTasks('+"'"+sortKey+"',true,true"+')" ')+('class="actionicon" src="./images/sort-descend-child.png"></img> ');
          ss += "<div class='tooltipclass'>Sort descending, preserving children.</div>";
          ss += (' <img class="actionicon" onclick="sortTasks('+"'"+sortKey+"',true,false"+')" ')+('class="actionicon" src="./images/sort-ascend-child.png"></img> ');
          ss += "<div class='tooltipclass'>Sort ascending, preserving children.</div>";

          ss += '</th>';
          return ss;
        }

        function writeTaskHeaders() {
          var ss = "";
          ss += ('<thead><tr>');
          // ss += ('<th class="exportButton" onclick="downloadData()">')
          ss += ('<th>')

            //Download
            ss += ('<img ');
            ss += ('onclick="downloadData()" ');
            // ss += ('onclick="downloadData('+task['id']+')" ');
            ss += ('class="actionicon" src="./images/download.png"></img> ');
            ss += "<div class='tooltipclass'>Download tasks to local drive.</div>";

            //Refresh
            ss += ('<img ');
            ss += ('onclick="rewriteAllTasks()" ');
            ss += ('class="actionicon" src="./images/refresh.png"></img> ');
            ss += "<div class='tooltipclass'>Refresh all tasks.</div>";

            //Global Collapse
            ss += ('<img ');
            ss += ('onclick="collapseAllTasks()" ');
            ss += ('class="actionicon" src="./images/minus-all.png"></img> ');
            ss += "<div class='tooltipclass'>Collapse all tasks.</div>";

            //Global Expand
            ss += ('<img ');
            ss += ('onclick="expandAllTasks()" ');
            ss += ('class="actionicon" src="./images/plus-all.png"></img> ');
            ss += "<div class='tooltipclass'>Expand all uncompleted tasks.</div>";

          ss += ('</th>');
          ss += writeSortableHeader("Task","desc");
          // ss += writeSortableHeader("Progress","completion");
          ss += writeSortableHeader("Sched. Date","_schedDateTime");
          ss += writeSortableHeader("Due Date","_dueDateTime");
          ss += writeSortableHeader("Start Date","_startDateTime");
          ss += writeSortableHeader("Est. Time","estTime");
          return ss;
        }

        function writeTaskTable() {
          var ss = "";
          var unavailable = [];
          for (var key in allTasks) {
            if (allTasks[key]["parent"] == 0) {
              if (allTasks[key]["_available"]) {
                ss += writeTaskData(allTasks[key],0);
              } else {
                unavailable.push(allTasks[key]);
              }
            }
          }
          for (var i = 0; i < unavailable.length; ++i) {
            ss += writeTaskData(unavailable[i],0);
          }
          return ss;
        }

        function writeTaskData(task,indent=0,recursive=true) {
          task["_depth"] = indent;
          var ss = "";
          var visibility = "onAdd";
          ss += ('<tr class="taskRow '+visibility+'">');
            ss += ('<td class="invisible">'+task['id']+'</td>');
            ss += writeTaskActions(task);
            ss += writeTaskDescription(indent,task);
            // ss += ('<td>'+getTaskProgress(task)+'</td>');
            ss += (getTaskSchedDate(task,true));
            ss += (getTaskDueDate(task,true));
            ss += (getTaskStartDate(task,true));
            ss += writeTaskEstimatedTime(task);
          ss += ('</tr>');
          if (recursive) {
            var unavailable = [];
            for (var j = 0; j < task["children"].length; j++) {
              if (task["children"][j]["_available"]) {
                ss += writeTaskData(task["children"][j],indent+1);
              } else {
                unavailable.push(task["children"][j]);
              }
            }
            for (var i = 0; i < unavailable.length; ++i) {
              ss += writeTaskData(unavailable[i],indent+1);
            }
          }
          return ss;
        }

        function completeRecurring(taskId) {
          rrate = allTasks[taskId]["recurRate"];
          dueDate = parseYmdDate(allTasks[taskId]["dueDate"],false);
          schedDate = parseYmdDate(allTasks[taskId]["schedDate"],false);
          startDate = parseYmdDate(allTasks[taskId]["startDate"],false);
          if (rrate == "weekly") {
            dueDate.setDate(dueDate.getDate() + 7);
            schedDate.setDate(schedDate.getDate() + 7);
            startDate.setDate(startDate.getDate() + 7);
          } else if (rrate == "monthly") {
            dueDate.setMonth(dueDate.getMonth() + 1);
            schedDate.setMonth(schedDate.getMonth() + 1);
            startDate.setMonth(startDate.getMonth() + 1);
          } else {
            return; //Invalid recur rate
          }
          if (allTasks[taskId]["dueDate"] != "") {
            var newDueDate = unparseYmdDate(dueDate);
            updateTask(taskId,"dueDate",newDueDate);
          }
          if (allTasks[taskId]["schedDate"] != "") {
            var newSchedDate = unparseYmdDate(schedDate);
            updateTask(taskId,"schedDate",newSchedDate);
          }
          if (allTasks[taskId]["startDate"] != "") {
            var newStartDate = unparseYmdDate(startDate);
            updateTask(taskId,"startDate",newStartDate);
          }
        }

        function postponeTask(taskId) {
          schedDate = parseYmdDate(allTasks[taskId]["schedDate"],false);
          schedDate.setDate(schedDate.getDate() + 1);
          var newSchedDate = unparseYmdDate(schedDate);
          updateTask(taskId,"schedDate",newSchedDate);
        }

        function scheduleTask(task) {
          //TODO: finish this
        }

        function writeTaskActions(task) {
          var ss = "";
          //Check
          ss += ('<td class="actiontd">');
          if (task["recurRate"] != "") {
            ss += ('<img onclick="completeRecurring('+task['id']+')" ');
            ss += ('class="actionicon" src="./images/recur.png">');
            ss += "</img> ";
            ss += "<div class='tooltipclass'>Complete and reschedule recurring task.</div>";
          }
          else {
            ss += ('<img onclick="toggleCompletion('+task['id']+')" ');
            if (parseInt(task["completion"]) == 1) {
              ss += ('class="actionicon" src="./images/check.png">');
              ss += "</img> ";
              ss += "<div class='tooltipclass'>Mark task as not completed.</div>";
            } else {
              ss += ('class="actionicon" src="./images/check-off.png">');
              ss += "</img> ";
              ss += "<div class='tooltipclass'>Mark task as completed.</div>";
            }
          }

          if (task["schedDate"] != "") {
            ss += ('<img onclick="postponeTask('+task['id']+')" ');
            ss += ('class="actionicon" src="./images/postpone.png">');
            ss += "</img> ";
            ss += "<div class='tooltipclass'>Postpone scheduled task for a day.</div>";
          } else {
            ss += ('<img onclick="modifyTask('+task['id']+",'modify_schedDate'"+')" ');
            ss += ('class="actionicon" src="./images/schedule.png">');
            ss += "</img> ";
            ss += "<div class='tooltipclass'>Schedule task for a specific date.</div>";
          }

          //Remove task
          ss += ('<img ');
          ss += ('onclick="deleteTask('+task['id']+')" ');
          ss += ('class="actionicon" src="./images/deletetask.png">');
          ss += "</img> ";
          ss += "<div class='tooltipclass'>Delete task.</div>";

          //New subtask
          ss += ('<img ');
          ss += ('onclick="newSubTask('+task['id']+')" ');
          ss += ('class="actionicon" src="./images/newtask.png">');
          ss += "</img> ";
          ss += "<div class='tooltipclass'>Add subtask.</div>";

          if (task['children'].length > 0) {
            if (! task["_collapsed"]) {
              //Collapse
              ss += ('<img ');
              ss += ('onclick="collapseTask('+task['id']+')" ');
              ss += ('class="actionicon" src="./images/minus.png">');
              ss += "</img> ";
              ss += "<div class='tooltipclass'>Collapse children.</div>";
            } else {
              //Expand
              ss += ('<img ');
              ss += ('onclick="expandTask('+task['id']+')" ');
              ss += ('class="actionicon" src="./images/plus.png">');
              ss += "</img> ";
              ss += "<div class='tooltipclass'>Expand children.</div>";
            }
          } else {
              //Placeholder
              ss += ('<img class="zeroopacity actionicon" src="./images/check-off.png"> </img>');
          }

          ss += "</td>";
          return ss;
        }

        function writeTaskDescription(indent,task) {
          var ss = "";
          var color = getTaskColor(task);
          ss += ('<td><div class="indentDiv" style="'
            +indentTextString(indent)
            +'" onclick="modifyTask('+task["id"]+')">'
            +'<div class="highlight" style="'
            +taskBG(color)
            +'">'
          );
          ss += (task['desc']);
          ss += (writeTaskTooltip(task));
          ss += ('</div></div></div></td>');
          return ss;
        }

        function writeTaskEstimatedTime(task) {
          var ss = "";
          ss += ('<td>');
          etime = task['estTime'];
          if (etime != "") {
            var time = etime.substr(0,etime.length - 1);
            var unit = etime.substr(etime.length - 1);
            if (unit == 'h') {
              time = time*60;
            }
            ss += (parseInt(time)+"m");
          }
          ss += ('</td>');
          return ss;
        }

        function rewriteAllTasks() {
          var trows = "";
          trows += writeTaskHeaders();
          for (key in allTasks) {
            if (allTasks[key]["parent"] == "") {
              trows += writeTaskData(allTasks[key],0,true);
            }
          }
          $("#taskTable tbody tr").remove();
          document.getElementById("taskTable").innerHTML = trows;
          // $('tr.taskRow').each(function(){
          //     var tr = $(this);
          //     var rowid = tr.find('td:eq(0)').text();
          //     var parent = allTasks[rowid]["parent"];
          //     if (parent != "" && allTasks[parent]["_collapsed"]) {
          //       tr.removeClass("onAdd");
          //       tr.addClass("onCollapse");
          //       tr.hide();
          //       // setTimeout(function(){tr.hide();},0);
          //     }
          // });
        }

        function sortTasks(sortKey,recurse=false,descend=true,parent="",depth=0) {
          var compkey = (descend ? -1 : 1)
          var trows = "";
          if (parent == "") {
            trows += writeTaskHeaders();
          }

          ntasks = Object.keys(allTasks).length;
          var writtenIDs = {};
          for (var i = 0; i < ntasks; ++i) {
            var minval = "";
            var minid = -1;
            for (var key in allTasks) {
              task = allTasks[key];
              //Skip children if we're recursing
              if (recurse && task['parent'] != parent) {
                continue;
              }
              //Skip things we've already written
              if (key in writtenIDs) {
                continue;
              }
              //Automatically add the first nonwritten value
              if (minid == -1) {
                minval = task[sortKey];
                minid = key;
                continue;
              }

              //Prefer uncomplete null over complete non-null
              var taskVal = task[sortKey];

              //Prefer uncompleted over completed
              if (parseInt(task["completion"]) == 1 && parseInt(allTasks[minid]["completion"]) != 1) {
                continue;
              }
              if (parseInt(task["completion"]) != 1 && parseInt(allTasks[minid]["completion"]) == 1) {
                minval = task[sortKey];
                minid = key;
                continue;
              }

              //Prefer non-null over null
              if (taskVal != "" && taskVal != " ") {
                if (minval == "" || minval == " ") {
                  minval = task[sortKey];
                  minid = key;
                  continue;
                }
              }

              //Compare with the new value
              if (taskVal.localeCompare(minval) == compkey) {
                if (taskVal == "" || taskVal == " ")
                  continue;
                minval = taskVal;
                minid = key;
              }
            }
            if (minid == -1) {
              break;
            }
            // alert(minid);
            writtenIDs[minid] = true;
            if (recurse) {
              //Write the task data for the minimal task, preserving it's indentation
              trows += writeTaskData(allTasks[minid],depth,false);
              //Write all of the children as well
              trows += sortTasks(sortKey,true,descend,minid,depth+1);
            }
            else {
              //Just write the current row without worrying about recursion
              trows += writeTaskData(allTasks[minid],0,false);
            }
          }
          if (parent == "") {
            //Write the whole table if we're at the top level of recursion
            $("#taskTable tbody tr").remove();
            document.getElementById("taskTable").innerHTML = trows;
          } else {
            //Return trows for the next recursion level up
            return trows;
          }
        }

        function toggleCompletion(id) {
          if(parseInt(allTasks[id]["completion"]) == 1) {
            updateTask(id,"completion",0);
          } else {
            updateTask(id,"completion",1);
          }
        }

        function updateTask(id,key,value) {
          setChangesMade();
          allTasks[id][key] = value;
          refreshTaskId(id);
        }

        function expandAllTasks() {
          for (var key in allTasks) {
            if (allTasks[key]["parent"] == "") {
              allTasks[key]["_collapsed"] = false;
              refreshTaskId(key);
              expandTask(key,true,true);
            }
          }
        }

        function expandTask(id,first=true,recurse=false) {
          //If we're recursively expanding or the first element in a tree to be expanded
          if (first || recurse) {
            //If we're not a completed tasked, we can expand
            if  (! parseInt(allTasks[id]["completion"]) == 1)
              allTasks[id]["_collapsed"] = false;
            //Even if we're completed, if we're the first element selected, we can expand
            else if (first)
              allTasks[id]["_collapsed"] = false;
            //Otherwise, we can't expand
            else
              allTasks[id]["_collapsed"] = true;
          }
          refreshTaskId(id);
          $('tr.taskRow').each(function(){
              var tr = $(this);
              var rowid = tr.find('td:eq(0)').text();
              if (id == rowid) {
                //Force transition
                if (! first) {
                  tr.addClass("onCollapse");
                  tr.removeClass("onAdd");
                }
                tr.show();
                tr.removeClass("onCollapse");
                tr.addClass("onAdd");
              }
          });
          //If the parent isn't still collapsed, expand the children
          if (! allTasks[id]["_collapsed"]) {
            for (var i = 0; i < allTasks[id]["children"].length; ++i) {
              expandTask(allTasks[id]["children"][i]['id'],false,recurse);
            }
          }
          //If the parent's collapsed, but we're told to go recursive, collapse all children
          else if (recurse) {
            for (var i = 0; i < allTasks[id]["children"].length; ++i) {
              collapseTask(allTasks[id]["children"][i]['id'],false,recurse);
            }
          }
        }

        function collapseTimer(i,to) {
          setTimeout(function(){
            i.removeClass("onAdd");
            i.addClass("onCollapse");
          },to);
          setTimeout(function(){
            i.hide();
          },to+500);
        }

        function collapseAllTasks() {
          var trlist = [];
          var parentlist = [];
          $('tr.taskRow').each(function(){
              var tr = $(this);
              var rowid = tr.find('td:eq(0)').text();
              // if(allTasks[rowid]["_collapsed"])
              //   return;
              allTasks[rowid]["_collapsed"] = true;
              if (allTasks[rowid]["parent"] != "") {
                trlist.push(tr);
              } else {
                parentlist.push(rowid);
              }
          });
          for (var i = 0; i < parentlist.length; ++i) {
            refreshTaskId(parentlist[i]);
          }
          for (var i = 0; i < trlist.length; ++i) {
            // collapseTimer(trlist[trlist.length-i-1],100+10*i);
            collapseTimer(trlist[trlist.length-i-1],trlist.length*2);
          }
        }

        function collapseTask(id,first=true,recurse=false) {
          // alert("collapse "+id);
          if (recurse || first) {
            allTasks[id]["_collapsed"] = true;
          }
          for (var i = 0; i < allTasks[id]["children"].length; ++i) {
            collapseTask(allTasks[id]["children"][i]['id'],false,recurse);
          }
          if(!first) {
            $('tr.taskRow').each(function(){
                var tr = $(this);
                var rowid = tr.find('td:eq(0)').text();
                if (id == rowid) {
                  tr.removeClass("onAdd");
                  tr.addClass("onCollapse");
                  setTimeout(function(){tr.hide();},500);
                }
            });
          }
          else {
            refreshTaskId(id);
          }
        }

      // File saving / loading

        function parseJsonConfig() {
          var rawFile = new XMLHttpRequest();
          rawFile.onreadystatechange = function () {
          if(rawFile.readyState === 4) {
              if(rawFile.status === 200 || rawFile.status == 0) {
                _config = JSON.parse(rawFile.responseText);
                if ("background_image" in _config) {
                  document.body.style.background = " url("+_config["background_image"]+")";
                }
                if ("default_sort" in _config) {
                  defaultSort = _config["default_sort"];
                  if ("default_sort_child" in _config) {
                    defaultSortChild = _config["default_sort_child"];
                  }
                }
                configLoaded = true;
              }
            }
          }
          rawFile.open("GET", "./todoconfig.json", false);
          try {
            rawFile.send(null);
          } catch(exception) {
            //Do nothing
          }
        }

        //Read in a todo-data CSV from the specified file and store it in allTasks
        function parseTaskCSV(file,backupfile) {
          var rawFile = new XMLHttpRequest();
          rawFile.onreadystatechange = function () {
          if(rawFile.readyState === 4) {
              if(rawFile.status === 200 || rawFile.status == 0) {
                var allText = rawFile.responseText.split('\n');
                var toWrite = "";
                for(var line = 0; line < allText.length; line++) {
                  if (allText[line].length < 1) {
                    continue;
                  }
                  split = allText[line].split('\t');
                  // alert(split);
                  if (split[0] == "") { //Ignore if no id
                    continue;
                  }
                  //Get field names from first line
                  if (line == 0) {
                    for (i = 0; i < split.length; i++) {
                      fields.push(split[i]);
                    }
                    continue;
                  }
                  var taskData = {};
                  taskData["_depth"] = 0;
                  taskData["children"] = [];
                  for (var i = 0; i < split.length; i++) {
                    taskData[fields[i]] = split[i];
                  }
                  for (var i = split.length; i < fields.length; i++) {
                    taskData[fields[i]] = "";
                  }
                  allTasks[taskData["id"]] = taskData;
                }
                //Write Children
                for (key in allTasks) {
                  if (allTasks[key]["parent"] > 0) {
                    allTasks[allTasks[key]["parent"]]["children"].push(allTasks[key]);
                  }
                }
              }
            }
          }
          rawFile.open("GET", file, false);
          try {
            rawFile.send(null);
          } catch(exception) {
            rawFile.open("GET", backupfile, false);
            rawFile.send(null);
          }
        }


        function generateCSV() {
          var ss = "id\tparent\tdeps\tcompletion\tdesc\tproject\tdueDate\tdueTime\tschedDate\tschedTime\tstartDate\tstartTime\tcolor\testTime\trecurRate\tpriority\n";
          for (var key in allTasks) {
            var task = allTasks[key];
            if (task["parent"] == "") {
              ss += generateCSVRow(task);
            }
          }
          ss = ss.replace(/[\u2018\u2019]/g, "'");
          return ss;
        }

        function generateCSVRow(task) {
          var ss = "";
          ss += task['id']+"\t";
          ss += task['parent']+"\t";
          ss += task['deps']+"\t";
          ss += task['completion']+"\t";
          ss += task['desc']+"\t";
          ss += task['project']+"\t";
          ss += task['dueDate']+"\t";
          ss += task['dueTime']+"\t";
          ss += task['schedDate']+"\t";
          ss += task['schedTime']+"\t";
          ss += task['startDate']+"\t";
          ss += task['startTime']+"\t";
          ss += task['color']+"\t";
          ss += task['estTime']+"\t";
          ss += task['recurRate']+"\t";
          ss += task['priority'];
          ss += "\n";

          for (var j = 0; j < task["children"].length; j++) {
            child = allTasks[task["children"][j]["id"]];
            // if (child == undefined) continue;
            ss += generateCSVRow(child);
          }

          return ss;
        }

        function downloadData() {
          download(generateCSV(),"_mydata.tsv","text/plain");
        }

        //From http://stackoverflow.com/questions/21012580/is-it-possible-to-write-data-to-file-using-only-javascript
        function download(strData, strFileName, strMimeType) {
            var D = document,
                A = arguments,
                a = D.createElement("a"),
                d = A[0],
                n = A[1],
                t = A[2] || "text/plain";

            //build download link:
            a.href = "data:" + strMimeType + "charset=utf-8," + escape(strData);


            if (window.MSBlobBuilder) { // IE10
                var bb = new MSBlobBuilder();
                bb.append(strData);
                return navigator.msSaveBlob(bb, strFileName);
            } /* end if(window.MSBlobBuilder) */



            if ('download' in a) { //FF20, CH19
                a.setAttribute("download", n);
                // a.innerHTML = "downloading...";
                D.body.appendChild(a);
                setTimeout(function() {
                    var e = D.createEvent("MouseEvents");
                    e.initMouseEvent("click", true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
                    a.dispatchEvent(e);
                    D.body.removeChild(a);
                }, 66);
                return true;
            }; /* end if('download' in a) */



            //do iframe dataURL download: (older W3)
            var f = D.createElement("iframe");
            D.body.appendChild(f);
            f.src = "data:" + (A[2] ? A[2] : "application/octet-stream") + (window.btoa ? ";base64" : "") + "," + (window.btoa ? window.btoa : escape)(strData);
            setTimeout(function() {
                D.body.removeChild(f);
            }, 333);
            return true;
        }

      // Todo list data generation

        //TODO: heavily clean up this function
        function computeExtraTaskData(task) {

          // alert(JSON.stringify(task,null,2));

          if (task['completion'] == "") {
            task['completion'] = "0";
          }

          if (! "_collapsed" in task) {
            task["_collapsed"] = false;
          }
          task["_tooltip"] = "This task can be done now.";
          task["_dependencies"] = "";
          task["_dueDateTime"] = task["dueDate"]+" "+task["dueTime"];
          task["_schedDateTime"] = task["schedDate"]+" "+task["schedTime"];
          task["_startDateTime"] = task["startDate"]+" "+task["startTime"];

          task['_available'] = true;

          var startDate = parseYmdDate(task['startDate'],false);
          if (parseInt(task["completion"]) == 1) {
            task['_available'] = false;  //Don't need to do finished tasks
            task["_tooltip"] = "Already done!";
          } else if (startDate > Date.now()) { //TODO: not guaranteed to have a valid startDate
            task['_available'] = false;  //Can't do future tasks
            task["_tooltip"] = "Not available until "+task['startDate']+" at "+task['startTime'];
          }
          if (task["deps"] != "") {
            var deps = task['deps'].split(",");
            if (deps.length > 0) {
              task["_dependencies"] = "Cannot do until the following tasks are done:\n\n";
            }
            for (var i = 0; i < deps.length; ++i) {
              if (! ("_dependents" in allTasks[deps[i]])) {
                allTasks[deps[i]]["_dependents"] = [];
              }
              allTasks[deps[i]]["_dependents"].push(task["id"]);
              var depCompleted = parseInt(allTasks[deps[i]]["completion"]) == 1;
              if (!depCompleted) {
                if (task['_available']) {
                  task['_available'] = false;  //Can't do a task with dependencies
                  task["_tooltip"] = "Has dependencies";
                }
              }
              status = depCompleted ? "./images/check.png" : "./images/cross.png";
              task["_dependencies"] += "<img class='tooltipicon' src='"+status+"'></img>  "
              +allTasks[deps[i]]["desc"]+"\n";
            }
            task["_dependencies"] +=  "<tr><td colspan='2'><hr/></td></tr>";
          }
        }

        function computeAllExtraTaskData() {
          for (var key in allTasks) {
            computeExtraTaskData(allTasks[key]);
          }
        }

        function generateHTML () {
          parseJsonConfig();
          parseTaskCSV(_config["data_file"],_config["data_file_fallback"]);
          computeAllExtraTaskData();
          document.write(writeAllTaskData());
          initTaskColors();
          sortTasks(defaultSort,defaultSortChild,true);
        }

        function sleep(ms) {
          return new Promise(resolve => setTimeout(resolve, ms));
        }

    </script>
  </head>
  <body><script>
    generateHTML();
    //Keycodes: https://css-tricks.com/snippets/javascript/javascript-keycodes/
    $(document).keyup(function(e) {
      if (e.keyCode == 27) { // escape key maps to keycode `27`
        dismissModifedTask();
      } else if (e.keyCode == 83) { // s
        // alert(e.target.tagName);
        if(e.target.tagName == "BODY") {
          downloadData();
          unsetChangesMade();
        }
      } else if (e.keyCode == 82) { // r
        rewriteAllTasks();
      }
    });
  </script></body>
</html>
